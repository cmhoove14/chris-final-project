---
title: "Optimal control of neglected tropical diseases using a simple dynamic model"
author: "Chris Hoover"
date: "May 18, 2018"
output: pdf_document 
geometry: margin=0.5in
---

-------

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(kableExtra)
library(knitr)
library(deSolve)
library(rootSolve)
library(MDPtoolbox)
```

Neglected tropical diseases (NTDs) tend to be diseases of poverty that thrive in tropical, disadvantaged communities that often lack access to basic amenities such as clean water, sanitation, and healthcare. They are generally environmentally mediated meaning that some component of their transmission cycle depends on the environment (e.g. a vector, intermediate host, or free-living environmental stage). Control of NTDs generally relies on the administration of drugs that cure individuals from the disease and may confer short-term immunity. However, following drug administration, people are often reinfected by the environmental stage(s) of the pathogen that persist through mass drug administration (MDA) campaigns. Additional interventions that target these environmental reservoirs are often available, but underutilized due to their indirect effects on improving individuals' health.

Using a simple, generalizable model of NTD transmission presented in [Garchitorena et al](http://rstb.royalsocietypublishing.org/content/372/1722/20160128), two interventions will be considered: 1) drug administration, implemented as a pulse reduction in the state variable, $I$, that reduces the prevalence of the disease in the population and 2) environmental remediation (e.g. improvement in sanitation, vector control), implemented as a permanent alteration of a model parameter, that reduces the transmission of the disease. 

## Part 1: Reproduce Fig3c
The first goal is to code the model and reproduce Figure 3c (below) from [Garchitorena et al](http://rstb.royalsocietypublishing.org/content/372/1722/20160128) comparing the effects of interventions that only target infected people, such as mass drug administration (MDA), to the effects of combined interventions that target infected people and the environment, such as sanitation, mosquito spraying, mollusciciding, etc.

\begin{figure}[!h]
\includegraphics[]{SupplementaryFiles/Fig3c.png}
\end{figure}

The model consists of two state variables, $I$ and $W$, that correspond to the prevalence of infection in the human population (i.e. proportion infected at time=$t$) and the degree of contamination of the environment with the disease-causing agent, respectively. We make the simplifying assumption that individuals can only be susceptible, $S$, or infected, $I$, meaning $S+I=1$ and eliminating the need for a recovered $R$ compartment as is typical of SIR models but would complicate things here. The model equations then are:  

\[\frac{dI}{dt}=(\beta_EW+\beta_DI)(1-I)-\gamma I \] 

\[\frac{dW}{dt}=\Omega+V\sigma\lambda I-\rho W \]

with parameter definitions and values in table 1 below

```{r table1, echo = FALSE, include = TRUE, dev="tikz" }
tab1 <- data.frame(val = as.character(c(9.26e-5, 5.55e-3, round(1/360, 3), 0,
                           1, 1, 1, round(1/60, 3))), 
                   des = c("Transmission rate from environment to human population",
                           "Human to human transmission rate",
                           "Rate of recovery from infected back to susceptible",
                           "Recruitment rate of infectious agents in the environment",
                           "Abundance of vectors/intermediate hosts/suitable environment",
                           "Recruitment rate of infectious agents by infectious individuals",
                           "Fraction of infectious agents produced that reach the environment",
                           "Mortality rate of infectious agents in the environment"))

rownames(tab1) <- c("$\\beta_E$","$\\beta_D$","$\\gamma$","$\\Omega$",
                     "$V$","$\\lambda$","$\\sigma$","$\\rho$")

knitr::kable(tab1, row.names = TRUE, col.names = c("Value", "Description"), format = "latex", escape = FALSE,
             caption = "Parameter values and descriptions used in the model")
```

We start by making the simplifying assumption that there is no exogenous production of infectious agents ($\Omega=0$) and that environment-human transmission is determined only by the transmission rate, $\beta_E$, with no role of vectors or intermediate hosts (i.e. $V=\sigma=\lambda=1$). This is approximately equivalent to a simple Cholera model with the form: 

\[\frac{dI}{dt}=(\beta_EW+\beta_DI)(1-I)-\gamma I \] 

\[\frac{dW}{dt}=I-\rho W \]

With this simplified model, we can get the equilibrium estimates of $W$ and $I$:
\[\frac{dW}{dt}=I-\rho W\]
At equilibrium:  
\[W^*=\frac{I}{\rho}\]
Substituting we get the following quadratic with solutions at $I^*=0$ and $I^*=\text{endemic equilibrium}$:
\[0=\Big(\frac{\beta_EI^*}{\rho}+\beta_DI^*\Big)\Big(1-I^*\Big)-\gamma I^* \]

Now we use these equilibrium estimates as starting values for the continuous time model and simulate ten years of interventions with the `deSolve` package to reproduce Fig 3c 

```{r mod_prep}
#Parameter values from table 1 (some excluded) drawn from Fig S1 of the manuscript
pars <- c(beta_e = 9.26e-5, beta_d = 5.55e-3,
          gamma = 1/360, rho = 1/60)

#Function to get equilibrium prevalence (I) and equilibrium environmental contamination (W)
get_eq <- function(parameters){
  with(as.list(parameters),{
    init <- rootSolve::uniroot.all(function(I) ((beta_e*I / rho) + beta_d*I)*(1-I) - gamma*I,
                                   interval = c(0,1))
    eq_I <- init[which(init > 0)]
    eq_W <- eq_I/rho
    
    return(c(I = eq_I, W = eq_W))
  })  
}

#Function to run model `t` days, with starting conditions `n` and parameter set `p`
simp_mod = function(t, n, p){
  with(as.list(p),{
    I = n[1]
    W = n[2]
    
    dIdt = (beta_e*W + beta_d*I)*(1-I) - gamma*I
    dWdt = I - rho*W
    
    return(list(c(dIdt, dWdt)))
  })
} 
  
#Events representing interventions to implement in the model
n_years <- 10       #Simulate 10 years of annual intervention
drug_efficacy = 0.9 #90% reduction in prevalence at each drug treatment
run_time <- c(1:(365*n_years)) #Run model for 10 years

#data frame with event times for drug administration
drugs <- data.frame(var=rep('I', times = n_years),
                        time = c(0:(n_years-1))*365 + 1,
                        value = rep((1-drug_efficacy), times = n_years),
                        method = rep("mult", times = n_years))
    
#Run model with annual drug administration intervention
drug_only <- as.data.frame(ode(get_eq(pars), run_time, simp_mod, pars,
                               events = list(data = drugs)))

#Double mortality rate of environmental infectious agents for environmental intervention
pars_env <- pars
pars_env["rho"] <- pars["rho"] * 2 

#Run model with annual drug administration and environmental intervention 
drug_env <- as.data.frame(ode(get_eq(pars), run_time, simp_mod, pars_env,
                               events = list(data = drugs)))

#Plot results
rbind(drug_env, drug_only) %>% 
  mutate(Intervention = c(rep("Drug + Env", length(run_time)),
                          rep("Drug", length(run_time)))) %>% 
  ggplot(aes(x = time/365, y = I, lty = Intervention)) + 
    theme_bw() + theme(legend.position = c(0.85,0.85)) +
    geom_line(size = 0.75) + xlab("time (years)") + ylab("Prevalence") + ylim(c(0,0.75))

```

Looks a little bit different from Fig 3c in that there's a higher starting prevalence and more rebound between drug treatments in the `Drug + Env` group. This is likely due to transmission parameters that are too high, so let's check that out.

```{r}
#Function to get R0 estimate given model parameters
get_r0 <- function(parameters){
  with(as.list(parameters),{
    r0_d <- beta_d / gamma
    r0_e <- beta_e / (gamma*rho)
    
    r0_d + r0_e
  })  
}

get_r0(pars)

```

So $R_0=4$ with the parameters pulled from the SI, but Fig3c says $R_0=3$. Let's see if we can bring the transmission parameters down a bit and get closer to Fig3c.

```{r}
r0 <- 3
pars2 <- pars

#Use equations from Fig S1 to estimate transmission parameters given desired r0 of 3
pars2["beta_d"] <- pars["gamma"]*r0 / 2
pars2["beta_e"] <- pars["gamma"]*r0*pars["rho"] / 2

get_r0(pars2)
```

Now that we have the same $R_0$, let's try the figure again

```{r}
# Rerun model with each intervention scenario and new parameter sets
drug_only2 <- as.data.frame(ode(get_eq(pars2), run_time, simp_mod, pars2,
                                events = list(data = drugs)))

pars_env2 <- pars2
pars_env2["rho"] <- pars2["rho"] * 2 

drug_env2 <- as.data.frame(ode(get_eq(pars2), run_time, simp_mod, pars_env2,
                               events = list(data = drugs)))

#Plot results 
rbind(drug_env2, drug_only2) %>% 
  mutate(intervention = c(rep("Drug + Env", length(run_time)),
                          rep("Drug", length(run_time)))) %>% 
  ggplot(aes(x = time/365, y = I, lty = intervention)) + 
    theme_bw() + theme(legend.position = c(0.85,0.85)) +
    geom_line(size = 0.75) + xlab("time (years)") + ylab("Prevalence") + ylim(c(0,0.75))

```

Looks about right!

## Part 2: Translate the model into a Markov Decision Process (MDP) solvable with stochastic dynamic programming (SDP)   
Next we want to translate our system of continuous time differential equations into a Markov Decision Process (MDP) consisting of **1)** a Markov chain in which the state of the system at time $t+1$ is dependent only on the current state of the system (i.e. the state at $t$) and **2)** a decision or control action that is being made at each state transition (i.e. from $t$ to $t+1$). We therefore want a single, discrete time equation that captures about the same dynamics of our simple disease system.

We'll again start with the assumption that the dynamics of the infectious agents in the environment are faster than the dynamics of the prevalence in the human population, therefore they reach a steady state equilibrium: \[W^*=\frac{I}{\rho}\] Again, substituting we get: \[\frac{dI}{dt}=\Big(\frac{\beta_EI}{\rho}+\beta_DI\Big)\Big(1-I\Big)-\gamma I \] which can be translated to a discrete time model as: \[I_{t+1}=I_t+\Big(\frac{\beta_EI_t}{\rho}+\beta_DI_t\Big)\Big(1-I_t\Big)-\gamma I_t \] let's check to make sure that the dynamics of the continuous time model hold in this simplified, discrete time version of the model.

```{r discrete_time}
#Discrete time version of the mode with functionality for MDA action if MDA=1 and no effect if MDA = 0
discrete_mod <- function(I, parameters, MDA=0){
  with(as.list(parameters),{
    ((beta_e * I)/rho + beta_d * I)*(1-I) - gamma*I - MDA*drug_efficacy*I
  })
}

discrete_sim <- function(time, I_0_drug, I_0_env, model, 
                         drug_parameters, env_parameters){
  
  #Initialize vectors to fill  
  drug_fill <- vector("numeric", length = time)
    drug_fill[1] <- I_0_drug
  env_fill <- vector("numeric", length = time)
    env_fill[1] <- I_0_env
  
  #Run models over time with MDA occurring in same years as above in continuous time model    
  for(t in 1:(time-1)){
    mda = ifelse(t %in% (c(0:(n_years-1))*365 + 1), 1, 0)
    
    drug_fill[t+1] <- drug_fill[t] + model(I = drug_fill[t], parameters = drug_parameters, MDA = mda)
    env_fill[t+1] <- env_fill[t] + model(I = env_fill[t], parameters = env_parameters, MDA = mda)
  }
    
  #Return results    
  return(tibble(Time = rep(c(1:time),2), 
                Intervention = c(rep("Drug", time), rep("Drug+Env", time)), 
                Prevalence = c(drug_fill, env_fill)))
  }

test_discrete <- discrete_sim(time = length(run_time), 
                              I_0_drug = get_eq(pars2)[1], 
                              I_0_env = get_eq(pars2)[1],
                              model = discrete_mod, 
                              drug_parameters = pars2, 
                              env_parameters = pars_env2)

ggplot(test_discrete, aes(x = Time/365, y = Prevalence, lty = Intervention)) + 
       theme_bw() + theme(legend.position = c(0.85,0.85)) +
       geom_line(size = 0.75) + xlab("time (years)") + ylab("Prevalence") + ylim(c(0,0.75))

```

It looks like our MDA intervention packs a bit more punch in this version of the model. That makes sense since we've simplified the environmental dynamics. To compensate, lets bump up the transmission parameter a bit.

```{r discrete_mod_mod}
#Bump up environment to human transmission parameter by 50%
  pars3 <- pars2
    pars3["beta_e"] <- pars2["beta_e"] * 1.5 
  pars_env3 <-pars_env2
    pars_env3["beta_e"] <- pars_env2["beta_e"] * 1.5 
    
test_discrete2 <- discrete_sim(time = length(run_time), 
                               I_0_drug = get_eq(pars3)[1], 
                               I_0_env = get_eq(pars3)[1],
                               model = discrete_mod, 
                               drug_parameters = pars3, 
                               env_parameters = pars_env3)

ggplot(test_discrete2, aes(x = Time/365, y = Prevalence, lty = Intervention)) + 
       theme_bw() + theme(legend.position = c(0.85,0.85)) +
       geom_line(size = 0.75) + xlab("time (years)") + ylab("Prevalence") + ylim(c(0,0.75))

```

That looks closer to what we started with, let's continue.

Now we'll work through the "Six steps of stochastic dynamic programming" as described in [Marescot et al](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12082) to get our MDP and set ourselves up for analysis 

1. **Define the optimization objective of the problem.**  
Our objective is to minimize the costs, $C$, associated with 1) infection of individuals and 2) implementing interventions to reduce their infections  

2. **Define the set of states that represent the configuration of the system at time $t$**  
We define the state variable, $X_t$, as the prevalence of infection in the human population, $I_t\in[0,1]$. 

3. **Define the decision variable, $A_t$ that is the component of the system to be controlled to meet the objective**  
We define the decision variable $A_t$ as the proportion of capital, $M$, committed to drug administration with the rest allocated towards environmental interventions.   

4. **Build a transition model describing the system's dynamics as a function of the decision variable and the system state in the prior time step**  
Beginning with the discrete time model above, we have: 
\[I_{t+1}=I_t+\Big(\frac{\beta_EI_t}{\rho}+\beta_DI_t\Big)\Big(1-I_t\Big)-\gamma I_t \]
Incorporating interventions based on our decision variable, $A_t$ gives us: \[I_{t+1}=I_t+\Big(\frac{\beta_EI_t}{\rho+M(1-A_t)\mu}+\beta_DI_t\Big)\Big(1-I_t\Big)-I_t(\gamma+MA_t\theta) \] Where $\theta$ is a constant that converts capital, $M$ to units of prevalence and $\mu$ is a constant that converts $M$ to the same units as the mortality rate of infectious agents in the environment.   

5. **Define the utility function $U_t(X_t,A_t)$ representing the desirability of acting in a given state**  
 \[\max_{A}C=\max_{A}\sum_0^T\frac{{-\Pi(I_t)}}{\delta_t}\] where \[\Pi(I_t)=dI_t\] $d$ is the cost associated with having prevalence of $I_t$ and $A_t$ is the proportion of that capital allocated towards drug administration (with the rest allocated towards environmental intervention). We're maximizing the negative costs, aka minimizing the costs.

6. **Determine the optimal solution of the optimization problem**  
Step 6 is Part 3, see below

## Part 3: Find the optimal solution using SDP in the `MDPtoolbox` R package  
Let's translate the problem outlined above into code, borrowing from the wolf culling example in Marescot et al  

